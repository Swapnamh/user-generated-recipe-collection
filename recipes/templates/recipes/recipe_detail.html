{% load static %}
{% load crispy_forms_tags %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ recipe.title }}</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #212529;
    }

    .card {
      border-radius: 1rem;
      box-shadow: 0 4px 18px rgb(0 0 0 / 0.1);
    }

    .card-img-top {
      transition: transform 0.3s ease;
      object-fit: cover !important;
      height: 400px;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
      cursor: pointer;
      width: 100%;
      display: block;
    }

    .card-img-top:hover {
      transform: scale(1.05);
    }

    .text-success {
      font-weight: 600;
      font-size: 1.25rem;
    }

    .bi-star, .bi-star-fill {
      font-size: 1.3rem;
      color: #ffc107;
    }

    .btn-success {
      border-radius: 50px;
      padding: 0.6rem 2.2rem;
      font-weight: 600;
      box-shadow: 0 4px 12px rgb(25 135 84 / 0.5);
      transition: all 0.25s ease-in-out;
    }

    .btn-success:hover {
      background-color: #198754cc;
      box-shadow: 0 6px 18px rgb(25 135 84 / 0.8);
      transform: scale(1.05);
    }

    .btn-primary {
      border-radius: 50px;
      font-weight: 600;
      padding: 0.6rem 1.8rem;
      box-shadow: 0 4px 12px rgb(13 110 253 / 0.5);
      transition: all 0.3s ease-in-out;
    }

    .btn-primary:hover {
      box-shadow: 0 7px 20px rgb(13 110 253 / 0.75);
      transform: scale(1.05);
    }

    @media (max-width: 767.98px) {
      .col-md-8, .col-md-4 {
        flex: 0 0 100%;
        max-width: 100%;
      }

      .card-body {
        padding: 1.5rem;
      }
    }

    .description-content {
      font-size: 1.05rem;
      line-height: 1.7;
      background: #ffffff;
      border: 1px solid #dee2e6;
      padding: 1.5rem;
      border-radius: 12px;
      white-space: pre-wrap;
    }

    .description-content p {
      margin-bottom: 1rem;
    }

    .description-content ul, .description-content ol {
      padding-left: 1.5rem;
      margin-bottom: 1rem;
    }

    .description-content li {
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>

  {% include 'recipes/partials/navbar.html' %}

  <div class="container my-4">

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    <div class="row">
      <div class="col-md-8">
        <div class="card mb-4 shadow-sm border-0 rounded-4">
          {% if recipe.image and recipe.image.url %}
            <img src="{{ recipe.image.url }}" class="card-img-top rounded-top-4" alt="{{ recipe.title }}">
          {% else %}
            <img src="{% static 'images/default_recipe.jpg' %}" class="card-img-top rounded-top-4" alt="{{ recipe.title }}">
          {% endif %}

          <!-- ✅ Recipe Video -->
          {% if recipe.video %}
          <div class="mt-4 px-4">
            <video controls class="w-100 rounded" style="max-height: 480px;">
              <source src="{{ recipe.video.url }}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          </div>
          {% endif %}

          <div class="card-body p-4">
            <h1 class="card-title fw-bold mb-3">{{ recipe.title }}</h1>

            {% if recipe.price %}
              <p class="fs-5 fw-semibold text-success mb-3">Price: ₹{{ recipe.price }}</p>
            {% endif %}

            <p class="text-muted mb-4">By <strong>{{ recipe.author.username }}</strong> | {{ recipe.created_at|date:"F j, Y" }}</p>

            <div class="mb-3 d-flex align-items-center">
              {% with avg_rating=recipe.average_rating %}
                {% for i in "12345" %}
                  {% if forloop.counter <= avg_rating %}
                    <i class="bi bi-star-fill text-warning fs-5"></i>
                  {% else %}
                    <i class="bi bi-star text-warning fs-5"></i>
                  {% endif %}
                {% endfor %}
                <span class="ms-2 text-secondary fw-semibold">({{ avg_rating|floatformat:1 }})</span>
              {% endwith %}
            </div>

            {% if recipe.is_for_sale %}
              <div class="alert alert-info rounded-3 shadow-sm">
                <h5 class="alert-heading fw-semibold">Price: ₹{{ recipe.price }}</h5>

                {% if user.is_authenticated %}
                  {% if not has_purchased and recipe.author != user %}
                    <form method="post" class="mt-3">
                      {% csrf_token %}
                      <button type="submit" name="buy_recipe" class="btn btn-success rounded-pill px-4">Buy Recipe</button>
                    </form>
                  {% elif has_purchased %}
                    <p class="mb-0 fw-semibold text-success">You've purchased this recipe!</p>
                  {% endif %}
                {% else %}
                  <p class="text-danger fw-semibold">Login to purchase this recipe.</p>
                {% endif %}
              </div>
            {% endif %}

            <h3>Description</h3>
            <div class="description-content">
              {{ recipe.description|linebreaksbr|safe }}
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card mb-4 shadow-sm border-0 rounded-4">
          <div class="card-body p-4">
            <h3 class="card-title fw-bold mb-3">Rate this Recipe</h3>
            {% if user.is_authenticated %}
              <form method="post">
                {% csrf_token %}
                {{ rating_form|crispy }}
                <button type="submit" name="rating_submit" class="btn btn-primary w-100 rounded-pill">Submit Rating</button>
              </form>
            {% else %}
              <p>Please <a href="{% url 'users:login' %}" class="text-decoration-underline">login</a> to rate this recipe.</p>
            {% endif %}
          </div>
        </div>

        {% if user != recipe.author %}
          <div class="card shadow-sm border-0 rounded-4">
            <div class="card-body p-4">
              <h3 class="card-title fw-bold mb-3">About the Author</h3>
              <div class="d-flex align-items-center mb-3">
                <div class="flex-shrink-0">
                  <i class="bi bi-person-circle text-primary" style="font-size: 3rem;"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                  <h5 class="mb-1">{{ recipe.author.username }}</h5>
                  <div class="text-warning mb-1">
                    {% with avg_rating=recipe.author.get_average_rating %}
                      {% for i in "12345" %}
                        {% if forloop.counter <= avg_rating %}
                          <i class="bi bi-star-fill"></i>
                        {% else %}
                          <i class="bi bi-star"></i>
                        {% endif %}
                      {% endfor %}
                      <span class="text-dark ms-2 fw-semibold">({{ avg_rating|floatformat:1 }})</span>
                    {% endwith %}
                  </div>
                </div>
              </div>
              <a href="{% url 'recipes:user_profile' recipe.author.id %}" class="btn btn-outline-primary w-100 rounded-pill">View Profile</a>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
